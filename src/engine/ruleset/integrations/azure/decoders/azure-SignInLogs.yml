name: decoder/azure-SignInLogs/0

sources:
  - decoder/azure-decoder/0

metadata:
  description: Decoder for Azure SignInLogs events
  module: Azure
  compatibility: >
    This decoder has been tested on Wazuh version 4.3
  author:
    name: Wazuh, Inc.
    date: 2023/02/01
  title: This decoder normalizes field from Azure SignInLogs
  references:
    - https://learn.microsoft.com/en-us/azure/active-directory/reports-monitoring/concept-sign-ins

check:
   - ~json.Type: SigninLogs

normalize:
  - map:
    - event.category: +array_append/authentication
    - event.kind: event
    - event.type: +array_append/info
    - azure.signinlogs.resource_id: $~json.ResourceId
    - source.address: $~json.IPAddress
    - source.ip: $source.address
    - related.ip: +array_append/$source.ip
    - client.ip: $source.ip
    - log.level: $~json.level
    - event.duration: $~json.DurationMs
    - event.duration: +int_calculate/mul/1000000
    - geo.country_iso_code: $~json.Location
    - event.action: $~json.OperationName
    - azure.tenant_id: $~json.TenantId
    - azure.correlation_id: $~json.CorrelationId
    - azure.signinlogs.properties.created_at: $~json.CreatedDateTime
    - azure.signinlogs.properties.processing_time_ms: $~json.ProcessingTimeInMilliseconds
    - azure.signinlogs.properties.risk_level_during_signin: $~json.RiskLevelDuringSignIn
    - message: $~json.FailureReason
    - ~temp.status: +parse_json/$~json.Status
    - azure.signinlogs.properties.status.error_code: $~temp.status.errorCode
    - azure.signinlogs.properties.status.additional_details: $~temp.status.additionalDetails
    - message: azure.signinlogs.properties.status.additional_details
    - ~temp.locationDetails: +parse_json/$~json.LocationDetails
    - geo.city_name: $~temp.locationDetails.city
    - geo.country_name: $~temp.locationDetails.state
    - geo.location.lat: $~temp.locationDetails.latitude
    - geo.location.lon: $~temp.locationDetails.longitude
    # azure.signinlogs.properties.authentication_processing_details is very difficult to parse
    - user.full_name: $~json.UserPrincipalName
    - user.id: $~json.UserId

    # User Agent
    - user_agent.original: $~json.UserAgent

    - azure.signinlogs.properties.authentication_processing_details: $~json.AuthenticationProcessingDetails
    - azure.signinlogs.identity: $~json.identity
    - azure.signinlogs.properties.app_display_name:  $~json.AppDisplayName
    - azure.signinlogs.properties.app_id: $~json.AppId
    - azure.signinlogs.properties.client_app_used: $~json.ClientAppUsed
    - azure.signinlogs.properties.conditional_access_status: $~json.ConditionalAccessStatus
    - azure.signinlogs.properties.device_detail: +parse_json/$~json.DeviceDetail
    - azure.signinlogs.properties.id: $~json.Id
    - azure.signinlogs.properties.is_interactive: $~json.IsInteractive
    - azure.signinlogs.properties.original_request_id: $~json.OriginalRequestId
    - azure.signinlogs.properties.risk_detail: $~json.RiskDetail
    - azure.signinlogs.properties.risk_level_aggregated: $~json.RiskLevelAggregated
    - azure.signinlogs.properties.risk_state: $~json.RiskState
    - azure.signinlogs.properties.service_principal_id: $~json.ServicePrincipalId
    - azure.signinlogs.properties.parsed_status: +parse_json/$~json.Status
    - azure.signinlogs.properties.token_issuer_name: $~json.TokenIssuerName
    - azure.signinlogs.properties.token_issuer_type: $~json.TokenIssuerType
    - azure.signinlogs.properties.user_display_name: $~json.UserDisplayName
    - azure.signinlogs.properties.user_id: $~json.UserId
    - azure.signinlogs.properties.user_principal_name: $~json.UserPrincipalName
    - azure.signinlogs.result_description : $~json.ResultDescription
    - azure.signinlogs.result_signature: $~json.ResultSignature
    - azure.signinlogs.result_type: $~json.ResultType
    - azure.resource.provider: $~json.ResourceProvider

  - check: NOT $~temp.status.errorCode OR $~temp.status.errorCode==0
    map:
     - event.outcome: success

  - check: $~temp.status.errorCode AND $~temp.status.errorCode>0
    map:
     - event.outcome: failure

  - logpar:
    - ~json.UserPrincipalName: <user.name>@<user.domain>

# Cleanup
  - map:
    - ~json: +delete
    - ~temp: +delete
